<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard</title>
    <link rel="stylesheet" href="Dashboard.css">
</head>

<body>
    <nav id="nav-bar">
        <div class="welcome-msg">
            <span id="username"></span>
        </div>
        <div class="nav-items">
            <img class="user-profile" id="profilePic" src="user-profile.svg" alt="">
        </div>
        <div class="coin-info">
            <img class="coin-photos" src="coin.png" alt="">
            <span id="coinBank">0</span>
        </div>
    </nav>

    <section class="main" id="links-container">
        <!-- Links will be dynamically inserted here -->
    </section>

    <script>
        const apiUrl = "https://backend-recent-2.onrender.com";

        document.addEventListener('DOMContentLoaded', async () => {
            const userId = new URLSearchParams(window.location.search).get('userId');
            if (!userId) {
                window.location.href = 'login.html';
                return;
            }

            try {
                const profileResponse = await fetch(`${apiUrl}/profiles/${userId}`, {
                    method: 'GET',
                    credentials: 'include'
                });

                const linksResponse = await fetch(`${apiUrl}/links`, {
                    method: 'GET',
                    credentials: 'include'
                });

                const profileData = await profileResponse.json();
                const linksData = await linksResponse.json();

                if (profileResponse.ok && linksResponse.ok) {
                    document.getElementById('username').textContent = profileData.name;
                    document.getElementById('coinBank').textContent = profileData.coins;
                    document.getElementById('profilePic').addEventListener('click', () => {
                        window.location.href = `profile.html?userId=${profileData.userId}`;
                    });

                    const linksContainer = document.getElementById('links-container');
                    linksContainer.innerHTML = '';  // Clear existing links

                    linksData.forEach((linkData) => {
                        const linkBox = document.createElement('div');
                        linkBox.classList.add('link-box');

                        const linkImgDiv = document.createElement('div');
                        linkImgDiv.classList.add('link-img');

                        const link = document.createElement('a');
                        link.href = linkData.url;
                        link.classList.add('link');
                        link.dataset.linkIndex = linkData.index; // Use the received index from backend

                        const img = document.createElement('img');
                        img.src = linkData.imageUrl;
                        img.alt = `link${linkData.index}`;

                        link.appendChild(img);
                        linkImgDiv.appendChild(link);
                        linkBox.appendChild(linkImgDiv);
                        linksContainer.appendChild(linkBox);

                        const linkStatus = profileData.linkStatus[linkData.index];
                        if (linkStatus) {
                            link.classList.add('clicked');
                            link.style.pointerEvents = 'none';
                            img.style.filter = 'blur(3px)';
                        }

                        link.addEventListener('click', async (event) => {
                            event.preventDefault();

                            const stayTime = 5000; // 5 seconds
                            const startTime = Date.now();

                            let timeoutId = setTimeout(() => {
                                alert("You did not stay at least 5 seconds on the clicked link page. You won't receive any coins.");
                                document.removeEventListener('visibilitychange', handleVisibilityChange);
                            }, stayTime);

                            const handleVisibilityChange = () => {
                                if (document.visibilityState === 'visible') {
                                    const elapsedTime = Date.now() - startTime;
                                    clearTimeout(timeoutId);
                                    if (elapsedTime >= stayTime) {
                                        updateCoinAndLinkState(linkData.index);
                                    } else {
                                        alert("You did not stay at least 5 seconds on the clicked link page. You won't receive any coins.");
                                    }
                                    document.removeEventListener('visibilitychange', handleVisibilityChange);
                                }
                            };

                            document.addEventListener('visibilitychange', handleVisibilityChange);
                            window.location.href = link.href; // Redirect to the clicked link
                        });
                    });
                } else {
                    console.error('Error:', profileData.message);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        });

        async function updateCoinAndLinkState(index) {
            try {
                const userId = new URLSearchParams(window.location.search).get('userId');
                const updateResponse = await fetch(`${apiUrl}/update-link`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ userId, linkIndex: index })
                });

                if (updateResponse.ok) {
                    const updatedData = await updateResponse.json();
                    const coinBank = document.getElementById('coinBank');
                    coinBank.textContent = updatedData.user.coins;
                    coinBank.classList.add('coin-animate');
                    setTimeout(() => coinBank.classList.remove('coin-animate'), 1000);

                    const links = document.querySelectorAll('.link');
                    links.forEach((link) => {
                        const linkIndex = parseInt(link.dataset.linkIndex, 10);
                        if (linkIndex === index) {
                            link.classList.add('clicked');
                            link.style.pointerEvents = 'none';
                            link.querySelector('img').style.filter = 'blur(3px)';
                        }
                    });
                } else {
                    console.error('Failed to update link status');
                }
            } catch (error) {
                console.error('Error updating link status:', error);
            }
        }
    </script>
</body>

</html>
