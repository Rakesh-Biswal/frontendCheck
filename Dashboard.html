<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard</title>
    <link rel="stylesheet" href="Dashboard.css">
    <style>
        @keyframes coinUpdate {
            from {
                color: gold;
                transform: scale(1.5);
            }
            to {
                color: inherit;
                transform: scale(1);
            }
        }

        .coin-animate {
            animation: coinUpdate 1s ease-in-out;
        }
    </style>
</head>

<body>
    <nav id="nav-bar">
        <div class="welcome-msg">
            <span>Welcome </span>
            <span id="username"></span>
        </div>
        <div class="nav-items">
            <img class="user-profile" id="profilePic" src="user-profile.svg" alt="">
            <a href="index.html" class="user-signOut">Sign out</a>
        </div>
        <div class="coin-info">
            <span>Coin Bank : </span>
            <span id="coinBank">0</span>
        </div>
    </nav>

    <section class="main">
        <div class="link-box">
            <!-- ... [link elements as provided in the original code] ... -->
        </div>
    </section>

    <script>
        const apiUrl = "https://backend-recent-2.onrender.com";
        document.addEventListener('DOMContentLoaded', async () => {
            const userId = new URLSearchParams(window.location.search).get('userId');
            if (!userId) {
                window.location.href = 'login.html';
                return;
            }

            try {
                const response = await fetch(`${apiUrl}/profiles/${userId}`, {
                    method: 'GET',
                    credentials: 'include'
                });

                const data = await response.json();
                if (response.ok) {
                    document.getElementById('username').textContent = data.name;
                    document.getElementById('coinBank').textContent = data.coins;
                    document.getElementById('profilePic').addEventListener('click', () => {
                        window.location.href = `profile.html?userId=${data.userId}`;
                    });
                    const links = document.querySelectorAll('.link');
                    links.forEach((link, index) => {
                        const linkStatus = data.linkStatus[index];

                        if (linkStatus) {
                            link.classList.add('clicked');
                            link.style.pointerEvents = 'none';
                            link.style.filter = 'blur(3px)';
                        }

                        link.addEventListener('click', (event) => {
                            event.preventDefault();
                            localStorage.setItem('linkClicked', true);
                            localStorage.setItem('linkIndex', index);
                            window.location.href = link.href;
                        });
                    });
                } else {
                    console.error('Error:', data.message);
                }
            } catch (error) {
                console.error('Error:', error);
            }

            const linkClicked = localStorage.getItem('linkClicked');
            const linkIndex = localStorage.getItem('linkIndex');
            if (linkClicked && linkIndex !== null) {
                localStorage.removeItem('linkClicked');
                localStorage.removeItem('linkIndex');

                const link = document.querySelector(`.link[data-link-index="${linkIndex}"]`);
                if (link) {
                    try {
                        fetch(`${apiUrl}/update-link`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ userId, linkIndex })
                        }).then(async response => {
                            if (response.ok) {
                                const updatedData = await response.json();
                                link.classList.add('clicked');
                                link.style.pointerEvents = 'none';
                                link.style.filter = 'blur(3px)';

                                const coinBank = document.getElementById('coinBank');
                                coinBank.textContent = updatedData.user.coins;
                                coinBank.classList.add('coin-animate');
                                setTimeout(() => coinBank.classList.remove('coin-animate'), 1000);
                            } else {
                                console.error('Failed to update link status');
                            }
                        });
                    } catch (error) {
                        console.error('Error updating link status:', error);
                    }
                }
            }
        });
    </script>
</body>

</html>
